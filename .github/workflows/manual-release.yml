name: Manual Release

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  package-and-release:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup environment
      id: setup
      run: |
        mkdir -p Publish/Actions
        DATE_TIME=$(date +'%Y-%m-%d_%H-%M')
        echo "DISPLAY_DATE=${DATE_TIME//_/ }" >> $GITHUB_OUTPUT
        echo "DATE_TIME=${DATE_TIME}" >> $GITHUB_OUTPUT

    - name: Package Windows files
      run: |
        cd src
        zip "../Publish/Actions/BBdownWindows_${{ steps.setup.outputs.DATE_TIME }}.zip" BBdownEasy.bat bbdownInstall.bat
        cd ..

    - name: Package Linux files
      run: |
        cd src
        tar -czvf "../Publish/Actions/BBdownLinux_${{ steps.setup.outputs.DATE_TIME }}.tar.gz" BBdownEasy.sh bbdownInstall.sh
        cd ..

    - name: Get commit logs
      id: changelog
      run: |
        echo "logs=$(git log --oneline -n 10 | sed ':a;N;$!ba;s/\n/\\n/g')" >> $GITHUB_OUTPUT

    - name: Create release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: release-${{ steps.setup.outputs.DATE_TIME }}
        name: AutoRelease ${{ steps.setup.outputs.DISPLAY_DATE }}
        body: |
          🚀 自动构建发布版本
          - 构建时间: ${{ steps.setup.outputs.DISPLAY_DATE }}
          - 最近提交记录:
          ${{ steps.changelog.outputs.logs }}
        files: |
          Publish/Actions/BBdownWindows_${{ steps.setup.outputs.DATE_TIME }}.zip
          Publish/Actions/BBdownLinux_${{ steps.setup.outputs.DATE_TIME }}.tar.gz