name: Manual Release

on:
  workflow_dispatch:  # 允许手动触发

permissions:
  contents: write

jobs:
  package-and-release:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # 获取完整提交历史

    - name: Setup environment
      run: |
        mkdir -p Publish/Actions
        DATE_TIME=$(date +'%Y-%m-%d_%H-%M')

    - name: Package Windows files
      run: |
        cd src
        zip "../Publish/Actions/BBdownWindows_$DATE_TIME.zip" BBdownEasy.bat bbdownInstall.bat
        cd ..

    - name: Package Linux files
      run: |
        cd src
        tar -czvf "../Publish/Actions/BBdownLinux_$DATE_TIME.tar.gz" BBdownEasy.sh bbdownInstall.sh
        cd ..

    - name: Get commit logs
      id: changelog
      run: |
        echo "logs=$(git log --oneline -n 10 | sed ':a;N;$!ba;s/\n/\\n/g')" >> $GITHUB_OUTPUT

    - name: Create release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: release-${{ env.DATE_TIME }}
        name: AutoRelease ${{ env.DATE_TIME | replace('_', ' ') }}
        body: |
          🚀 自动构建发布版本
          - 构建时间: ${{ env.DATE_TIME | replace('_', ' ') }}
          - 最近提交记录:
          ${{ steps.changelog.outputs.logs }}
        files: |
          Publish/Actions/BBdownWindows_${{ env.DATE_TIME }}.zip
          Publish/Actions/BBdownLinux_${{ env.DATE_TIME }}.tar.gz